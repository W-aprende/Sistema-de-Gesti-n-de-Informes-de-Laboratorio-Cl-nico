<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LABORATORIO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
:root{
  --bg:#f4f8fb;
  --card:#FFFF;
  --navy:#000000;
  --teal:#0f9d8e;
  --blue:#3aa0ff;
  --muted:#6e727b;
  --radius:12px;
  --shadow: 0 10px 30px rgba(11,57,84,0.08);
}
*{box-sizing:border-box}
body{
  font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;
  background:linear-gradient(180deg,var(--bg),#06cee8);
  margin:0;
  color:var(--navy);
  padding-top:88px;
  padding-bottom:0;
}
.container{max-width:1500px;margin:0 auto;padding:18px}
.header{position:fixed;top:0;left:0;right:0;height:90px;background:var(--card);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:1000}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:#f9f9f9;display:flex;align-items:center;justify-content:center;color:rgb(255, 255, 255);font-weight:700;font-size:20px;box-shadow:var(--shadow)}
.title{font-size:20px;font-weight:700}
.subtitle{color:var(--muted);font-size:13px}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:var(--navy);color:rgb(255, 255, 255);padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center}
.btn.ghost{background:transparent;color:var(--navy);border:1px solid #0b489d}
.btn.danger{background:#dc3545;color:white}
.small{font-size:13px;color:var(--muted)}
.grid{display:flex;gap:14px;align-items:flex-start}
.main-col{flex:1;overflow-y:auto;max-height:calc(100vh - 110px)}
.sidebar{width:340px;position:sticky;top:88px;flex-shrink:0}
.card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);margin-bottom:14px}
.patient{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.patient input, .patient select, .patient button{padding:10px;border-radius:8px;border:1px solid #1b94b5}
.reports-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
  align-items: stretch;
  padding: 10px;
}
.report-card {
  width: 200px;
  min-height: 140px;
  border-radius: 16px;
  padding: 16px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: linear-gradient(135deg, #1dd708, #02f3ef);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  color: #000000;
  font-family: 'Segoe UI', sans-serif;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  backdrop-filter: blur(4px);
}
.report-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 24px rgba(0, 0, 0, 0.15);
}
.report-card.inactive {
  filter: grayscale(0.7) opacity(0.6);
}
.report-card .icon {
  font-size: 32px;
  margin-bottom: 8px;
}
.report-card h3 {
  font-size: 15px;
  font-weight: 600;
  margin: 0 0 4px 0;
  letter-spacing: 0.5px;
}
.report-card .small {
  font-size: 12px;
  opacity: 0.85;
}
.report-card .checkbox {
  margin-top: 8px;
}
.report-card.inactive{filter:grayscale(.6) opacity(.55)}
.report-card h3{margin:0}
.checkbox{display:flex;align-items:center;gap:8px}
.sections{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.sect-block{display:flex;gap:8px;flex-wrap:wrap}
.sect-item{padding:8px 10px;border-radius:8px;background:#f7fbff;border:1px solid #eaf6ff;display:flex;align-items:center;gap:6px}
.select-all{margin-left:auto;background:var(--teal);color:white;padding:6px 8px;border-radius:8px;border:none;cursor:pointer;font-size:13px}
.params{display:flex;flex-direction:column;gap:12px;margin-top:12px}
table{width:100%;border-collapse:collapse;border-radius:8px;overflow:hidden}
th,td{padding:8px;border-bottom:1px solid #edf5ff;text-align:left;font-size:14px}
th{background:linear-gradient(90deg,#f5fbff,#f1f8ff);font-weight:600;color:var(--navy)}
.param-input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8}
.signature-box{border:2px dashed #e6eef8;padding:10px;border-radius:10px;min-width:320px;background:#fbfdff}
.sig-canvas{border-radius:8px;background:white;border:1px solid #e7f0fb;touch-action: none}
.sig-controls{display:flex;gap:6px;margin-top:8px}
.select-prof{padding:8px;border-radius:8px;border:1px solid #e6eef8}
.badge{font-size:12px;color:#fff;background:var(--teal);padding:6px 8px;border-radius:8px}
.modal{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal.open{display:flex}
.preview-box{width:90%;height:90%;background:white;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
.modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px;background:linear-gradient(90deg,var(--navy),var(--blue));color:white}
.preview-frame{flex:1;border:0;width:100%}
.kv{font-size:13px;color:var(--muted)}
.counter-display{font-size:24px;font-weight:700;color:var(--teal);text-align:center;margin:8px 0}
.date-input{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin:8px 0}
.history-actions{display:flex;flex-direction:column;gap:8px}
.btn-add-option{background:#0f9d8e;color:white;border:none;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer}
.btn-remove-option{background:#dc3545;color:white;border:none;border-radius:6px;padding:6px 10px;font-size:14px;cursor:pointer;margin-left:4px}

/* MODALES MODERNOS */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(3px);
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 16px;
  padding: 28px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease-out;
}
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 2px solid #f0f2f5;
  padding-bottom: 16px;
}
.modal-header h2 {
  margin: 0;
  color: #0b3954;
  font-size: 22px;
}
.modal-close-btn {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #999;
  transition: color 0.2s;
}
.modal-close-btn:hover {
  color: #0b3954;
}
.form-group {
  margin-bottom: 16px;
}
.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #0b3954;
  font-size: 14px;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 12px;
  border: 2px solid #e6eef8;
  border-radius: 8px;
  font-size: 14px;
  font-family: inherit;
  transition: border-color 0.2s;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: #0f9d8e;
  box-shadow: 0 0 0 3px rgba(15, 157, 142, 0.1);
}
.form-group textarea {
  resize: vertical;
  min-height: 100px;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 24px;
  justify-content: flex-end;
}
.btn-modal {
  padding: 12px 20px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}
.btn-modal-primary {
  background: #0f9d8e;
  color: white;
}
.btn-modal-primary:hover {
  background: #0d8872;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(15, 157, 142, 0.3);
}
.btn-modal-secondary {
  background: #f0f2f5;
  color: #0b3954;
}
.btn-modal-secondary:hover {
  background: #e6eef8;
}
.btn-modal-danger {
  background: #dc3545;
  color: white;
}
.btn-modal-danger:hover {
  background: #c82333;
}
.form-hint {
  font-size: 12px;
  color: #6e727b;
  margin-top: 6px;
}
.section-container {
  background: #f9fbff;
  border: 2px dashed #0f9d8e;
  border-radius: 8px;
  padding: 12px;
  margin: 12px 0;
}
.section-input-group {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  align-items: center;
}
.section-input-group input {
  flex: 1;
}
.btn-remove-section {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}
.btn-add-section {
  background: #0f9d8e;
  color: white;
  border: none;
  padding: 10px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 10px;
}
.param-options {
  background: #f9fbff;
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
}
.param-option-item {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  align-items: center;
}
.param-option-item input {
  flex: 1;
}
.param-option-item button {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
}
.success-message {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
}
.error-message {
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  color: #721c24;
  padding: 12px;
  border-radius: 8px;
  margin-top: 10px;
}

/* ===== PIE DE P√ÅGINA MODERNO (VERSI√ìN LIMPIA) ===== */
.modern-footer {
  background: linear-gradient(135deg, #0b3954 0%, #1b5e80 50%, #0f9d8e 100%);
  color: #fff;
  padding: 40px 0 20px 0;
  margin-top: 0;
  border-top: 4px solid #00d4d4;
  box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
  width: 100%;
}

.footer-container {
  max-width: 1500px;
  margin: 0 auto;
  padding: 0 18px 30px 18px;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
}

.footer-section h3 {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 12px 0;
  color: #00d4d4;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.footer-section h4 {
  font-size: 14px;
  font-weight: 700;
  margin: 0 0 12px 0;
  color: #fff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.footer-section p {
  font-size: 13px;
  line-height: 1.6;
  color: rgba(255, 255, 255, 0.85);
  margin: 6px 0;
}

.footer-meta {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.65);
  font-style: italic;
}

.footer-section ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.footer-section ul li {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.85);
  line-height: 1.8;
  margin: 8px 0;
  transition: all 0.2s ease;
}

.footer-section ul li:hover {
  color: #00d4d4;
  transform: translateX(4px);
}

.footer-section a {
  color: rgba(255, 255, 255, 0.85);
  text-decoration: none;
  transition: all 0.2s ease;
  border-bottom: 1px solid transparent;
}

.footer-section a:hover {
  color: #00d4d4;
  border-bottom: 1px solid #00d4d4;
}

.footer-divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  margin: 20px 18px;
  max-width: 1500px;
  margin-left: auto;
  margin-right: auto;
}

.footer-copyright {
  background: rgba(0, 0, 0, 0.2);
  padding: 20px 18px;
  text-align: center;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  margin: 0;
}

.footer-copyright p {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.85);
  margin: 6px 0;
  line-height: 1.6;
}

.footer-copyright p strong {
  color: #00d4d4;
  font-weight: 700;
}

.footer-tagline {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.65);
  margin-top: 8px;
}

/* Responsive footer */
@media (max-width: 768px) {
  .footer-container {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .modern-footer {
    padding: 30px 0 15px 0;
    margin-top: 0;
  }
  
  .footer-section h3 {
    font-size: 18px;
  }
  
  .footer-section h4 {
    font-size: 13px;
  }
  
  .footer-copyright p {
    font-size: 12px;
  }
}
/* ...existing code... */
</style>
</head>
<body>

  <!-- LOGIN SIMPLE -->
<div id="loginScreen" style="
  position: fixed;
  inset: 0;
  background: linear-gradient(180deg, #f4f8fb, #06cee8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
  <div style="
    background: white;
    padding: 40px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 400px;
  ">
    <center>
      <img src="LogoPrincipal.png" alt="Logo" style="width:100px;height:92px;object-fit:contain;margin-bottom:20px;">
      <h2 style="margin:0 0 10px 0;color:#0b3954;">Sistema de Gestion de informes</h2>
      <p style="margin:0 0 20px 0;color:#6e727b;font-size:14px;">Laboratorio Cl√≠nico</p>
    </center>
    <form onsubmit="handleLogin(event)">
      <div style="margin-bottom:16px;">
        <label style="display:block;font-weight:600;margin-bottom:6px;color:#0b3954;">Usuario</label>
        <input type="text" id="username" required style="width:100%;padding:12px;border:2px solid #e6eef8;border-radius:8px;font-size:14px;">
      </div>
      <div style="margin-bottom:20px;position:relative;">
        <label style="display:block;font-weight:600;margin-bottom:6px;color:#0b3954;">Contrase√±a</label>
        <input type="password" id="password" required style="width:100%;padding:12px 40px 12px 12px;border:2px solid #e6eef8;border-radius:8px;font-size:14px;">
        <button type="button" onclick="togglePassword()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;"><br><br>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0b3954" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
        </button>
      </div>
      <button type="submit" style="width:100%;padding:12px;background:#0f9d8e;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Ingresar</button>
    </form>
    <p id="loginError" style="color:#dc3545;font-size:13px;margin-top:10px;text-align:center;"></p>
  </div>
</div>

<div class="header">
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <img src="LogoPrincipal.png" style="width:100px;height:92px;object-fit:contain;">
    </div>
    <div>
      <div class="title">CLINICA VIRGEN DE GUADALUPE ‚Äì MALABO</div>
      <div class="subtitle">Calle Rey Malabo ¬∑ Tel/fax +240 333 099013</div>
    </div>
  </div>
  <div class="actions">
    <button id="btnOpenPreview" class="btn" title="Abrir vista previa (a partir de ah√≠ puedes guardar PDF o imprimir)">üëÅÔ∏è Abrir vista previa</button>
    <button id="btnNew" class="btn ghost" title="Limpiar todo y empezar nuevo informe">‚ôªÔ∏è Nuevo informe</button>
    <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">üö™ Cerrar sesi√≥n</button>
  </div>
</div>
<div style="display:none">ID √∫nico: ANEWM-182839</div>
<div class="container">
  <div class="grid">
    <div class="main-col">
      <div class="card">
        <center><h1><strong>CREACION DE INFORMES DE LABORATORIO</strong></h1></center><br>
        <strong>DATOS DEL PACIENTE</strong>
        <div class="patient" style="margin-top:8px">
          <input id="p_fecha" type="date" title="Fecha del informe">
          <input id="p_historial" type="text" placeholder="N¬∫ historial" title="N√∫mero de historial">
          <input id="p_nombre" type="text" placeholder="Nombre completo" title="Nombre del paciente">
          <input id="p_edad" type="text" placeholder="Edad" title="Edad">
          <select id="p_sexo" title="Sexo"><option value="">Sexo</option><option value="Masculino">M</option><option value="Femenino">F</option></select>
          <input id="p_reg" type="text" placeholder="N¬∫ registro" title="N√∫mero de registro">
        </div>
        <div style="margin-top:12px">
          <strong>1. SELECCIONA INFORMES DE LABORATORIO</strong>
          <div id="reportsGrid" class="reports-grid"></div>
          <div class="small" style="margin-top:6px">Los informes no incluidos quedan visibles en segundo plano; act√≠valos para editar sus secciones.</div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>2. SELECCIONA LAS SECCIONES (por informe)</strong>
        <div id="sectionsContainer" class="sections"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>3. PARRAMETROS (marcar y rellenar)</strong>
        <div id="paramsContainer" class="params"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>FIRMA Y EL SELLO</strong>
          <div class="kv">Selecciona qui√©n firma; la firma se incrustar√° en el PDF</div>
        </div>
        <div style="display:flex;gap:12px;margin-top:10px;flex-wrap:wrap">
          <select id="professionalSelect" class="select-prof">
            <option value="FIRMA Y SELLO DEL ANALISTA">FIRMA Y SELLO DEL ANALISTA</option>
          </select>
          <input id="professionalTitle" placeholder="Cargo (p.ej. Jefe de laboratorio)" style="padding:8px;border-radius:8px;border:1px solid #e6eef8">
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start;margin-top:12px">
          <div class="signature-box" style="flex:1" id="sigArea">
            <div class="kv">Adjuntar firma</div>
            <canvas id="sigCanvas" class="sig-canvas" width="400" height="120" style="width:100%;height:320px;margin-top:5px"></canvas>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="clearSig" class="btn ghost">Borrar</button>
              <button id="saveSig" class="btn">Guardar</button>
              <label class="btn ghost" style="display:inline-block;padding:10px 12px;cursor:pointer">
                üñáÔ∏è Adjuntar firma
                <input id="sigFile" type="file" accept="image/*" style="display:none">
              </label>
            </div>
          </div>
          <div style="width:300px">
            <div class="kv">Comentarios / Observaciones</div>
            <textarea id="finalNotes" rows="6" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef8;margin-top:8px"></textarea>
            <div class="kv" style="margin-top:8px">Estado: <span id="statusBox">Listo</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <div class="card">
        <strong>Acciones r√°pidas</strong>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <button id="selectAllSections" class="btn ghost">Seleccionar todas secciones</button>
          <button id="deselectAllSections" class="btn ghost">Deseleccionar todas secciones</button>          
          <button id="btnAddReport" class="btn ghost">‚ûï A√±adir informe</button>
          <button id="btnUpdateReport" class="btn ghost">‚úèÔ∏è Actualizar informe</button>
          <button id="btnDeleteReport" class="btn danger">üóëÔ∏è Eliminar informe</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Vista previa & PDF</strong>
        <div style="margin-top:10px">
          <button id="btnOpenPreview2" class="btn">Abrir vista previa</button>
          <div class="small" style="margin-top:8px">Desde la vista previa usa Imprimir o Guardar como PDF.</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal vista previa -->
<div id="modalPreview" class="modal" role="dialog" aria-hidden="true">
  <div class="preview-box" role="document">
    <div class="modal-head">
      <div>Vista previa</div>
      <div style="display:flex;gap:8px">
        <button id="modalPrint" class="btn ghost">üñ®Ô∏è Imprimir</button>
        <button id="modalClose" class="btn ghost">Cerrar</button>
      </div>
    </div>
    <iframe id="previewFrame" class="preview-frame" title="Vista previa"></iframe>
  </div>
</div>


<!-- MODAL: A√ëADIR INFORME -->
<div id="modalAddReport" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìã Nuevo Informe</h2>
      <button class="modal-close-btn" onclick="closeModal('modalAddReport')">‚úï</button>
    </div>
    <form id="formAddReport" onsubmit="handleAddReport(event)">
      <div class="form-group">
        <label>Nombre del Informe *</label>
        <input type="text" id="addReportTitle" placeholder="ej. BIOQU√çMICA" required>
        <div class="form-hint">Ser√° visible en la interfaz principal</div>
      </div>

      <div class="form-group">
        <label>ID Interno *</label>
        <input type="text" id="addReportId" placeholder="ej. bioquimica" required>
        <div class="form-hint">Solo letras y n√∫meros, sin espacios</div>
      </div>

      <div class="form-group">
        <label>Icono (Emoji) *</label>
        <input type="text" id="addReportIcon" placeholder="ej. üß™" value="üß™" maxlength="2" required>
        <div class="form-hint">Pega un emoji aqu√≠</div>
      </div>

      <div class="form-group">
        <label>Secciones *</label>
        <div id="addReportSections"></div>
        <button type="button" class="btn-add-section" onclick="addSectionField('addReportSections')">‚ûï Agregar Secci√≥n</button>
      </div>

      <div id="messageAddReport"></div>

      <div class="modal-actions">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('modalAddReport')">Cancelar</button>
        <button type="submit" class="btn-modal btn-modal-primary">Crear Informe</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: ACTUALIZAR INFORME -->
<div id="modalUpdateReport" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚úèÔ∏è Actualizar Informe</h2>
      <button class="modal-close-btn" onclick="closeModal('modalUpdateReport')">‚úï</button>
    </div>
    <form id="formUpdateReport" onsubmit="handleUpdateReport(event)">
      <div class="form-group">
        <label>Seleccionar Informe *</label>
        <select id="updateReportSelect" required onchange="loadUpdateReportOptions()">
          <option value="">-- Selecciona un informe --</option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øQu√© deseas actualizar? *</label>
        <select id="updateMode" required onchange="toggleUpdateFields()">
          <option value="informe">Informe General</option>
          <option value="seccion">Secci√≥n</option>
          <option value="parametro">Par√°metro</option>
        </select>
      </div>

      <div id="updateFieldsContainer"></div>
      <div id="messageUpdateReport"></div>

      <div class="modal-actions">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('modalUpdateReport')">Cancelar</button>
        <button type="submit" class="btn-modal btn-modal-primary">Actualizar</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL: ELIMINAR ELEMENTO -->
<div id="modalDeleteReport" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üóëÔ∏è Eliminar Elemento</h2>
      <button class="modal-close-btn" onclick="closeModal('modalDeleteReport')">‚úï</button>
    </div>
    <form id="formDeleteReport" onsubmit="handleDeleteReport(event)">
      <div class="form-group">
        <label>Seleccionar Informe *</label>
        <select id="deleteReportSelect" required onchange="loadDeleteReportOptions()">
          <option value="">-- Selecciona un informe --</option>
        </select>
      </div>

      <div class="form-group">
        <label>¬øQu√© deseas eliminar? *</label>
        <select id="deleteMode" required onchange="toggleDeleteFields()">
          <option value="informe">Eliminar Informe Completo</option>
          <option value="seccion">Eliminar Secci√≥n</option>
          <option value="parametro">Eliminar Par√°metro</option>
        </select>
      </div>

      <div id="deleteFieldsContainer"></div>

      <div style="background: #fff3cd; border: 1px sol id #ffc107; padding: 12px; border-radius: 8px; margin: 12px 0; color: #856404;">
        <strong>‚ö†Ô∏è Advertencia:</strong> Esta acci√≥n no se puede deshacer.
      </div>

      <div id="messageDeleteReport"></div>

      <div class="modal-actions">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('modalDeleteReport')">Cancelar</button>
        <button type="submit" class="btn-modal btn-modal-danger">Eliminar Permanentemente</button>
      </div>
    </form>
  </div>
</div>

<!-- PIE DE P√ÅGINA MODERNO -->
<footer class="modern-footer">
  <div class="footer-container">
    <div class="footer-section">
      <center><img src="LogoPrincipal.png" style="width:150px;height:92px;object-fit:contain;"></center>
      <h3>Cl√≠nica Virgen de Guadalupe</h3>
      <p>Sistema de Informes de Laboratorio Cl√≠nico</p>
      <p class="footer-meta">Malabo, Guinea Ecuatorial</p>
    </div>
    
    <div class="footer-section">
      <h4>Contacto</h4>
      <ul>
        <li>üìç Calle Rey Malabo ¬∑ MALABO</li>
        <li>üìû +240 350 093 213 | +240 350 093 242</li>
        <li>üìß info@clinicavirgenguadalupe.net</li>
        <li>üìß Laboratorio@clinicavirgenguadalupe.net </li>
        <li>üí¨ WhatsApp: 555 314 387</li>
        <li>üè¶ BANGE: Clinica virgen de guadalupe II</li>
        <li>üí≥ Centa: 37108887303-50</li>
      </ul>
    </div>
    
    <div class="footer-section">
      <h4>Informaci√≥n</h4>
      <ul>
        <li><a href="#" onclick="alert('Versi√≥n 1.2.0')">Versi√≥n del Sistema</a></li>
        <li><a href="#" onclick="alert('Es un Pagina web todo en uno desarrollado con tecnolog√≠as web modernas')">Sobre el Sistema</a></li>
        <li><a href="#" onclick="alert('En Cl√≠nica Virgen de Guadalupe, proteger tu privacidad es una prioridad fundamental. Esta Pol√≠tica de Privacidad explica c√≥mo recopilamos, usamos, compartimos y protegemos tu informaci√≥n personal cuando utilizas nuestro Sistema de Gesti√≥n de Informes Cl√≠nicos.')">Privacidad</a></li>
      </ul>
    </div>
    
    <div class="footer-section">
      <h4>Desarrollador</h4>
      <p><strong>√Ångel Nicol√°s Esono WONG MODJO</strong></p>
      <p class="footer-meta">Desarrollador de Sistemas</p>
    </div>
  </div>
  
  <div class="footer-divider"></div>
  
  <div class="footer-copyright">
    <p>&copy; 2025 Cl√≠nica Virgen de Guadalupe. Todos los derechos reservados a <strong>√Ångel Nicol√°s Esono WONG MODJO</strong></p>
    <p class="footer-tagline">Sistema de Gesti√≥n de Informes Cl√≠nicos | v1.2.0</p>
  </div>
</footer>
                                                          
<script>
/* ===============================================
   CLINICA VIRGEN DE GUADALUPE - Sistema de Informes
   =============================================== */

// LOGO EXACTO en formato Base64 SVG
const logoBase64 = "LogoPrincipal.png";

const REPORTS = {
  hematologia: {
    id:"hematologia", icon:"ü©∏", title:"HEMATOLOG√çA",
    sections:{
      coagulograma_completo: {title:"COAGULOGRAMA COMPLETO", params:[
        {k:"Fibrin√≥geno", unit:"Mg/dL", normal:"200-400"},
        {k:"Tiempo de Protrombina", unit:"Segundos", normal:"10-14"},
        {k:"INR", unit:"---------", normal:"0.8-1.2"},
        {k:"TTPA", unit:"Segundos", normal:"25-45"},
        {k:"Tiempo de Trombina", unit:"Segundos", normal:"9-35"},
        {k:"D√≠mero D", unit:"ng/mL", normal:"< 500"}
      ]},
      coagulograma_minimo: {title:"COAGULOGRAMA MINIMO", params:[
        {k:"Recuento de plaquetas", unit:"Plaquetas/mL", normal:"150.000-450.000"},
        {k:"Tiempo de sangrado (Duke)", unit:"Minutos", normal:"3-7"},
        {k:"Tiempo de coagulaci√≥n (Lee-White)", unit:"Minutos", normal:"5-10"}
      ]},
      vsg: {title:"VELOCIDAD DE SEDIMENTACION GLOBULAR", params:[
        {k:"1¬™ Hora", unit:"mm/h", normal:"Hombres:0-15/h, [[br]]Mujer:0-20/h, [[br]]Ni√±os:0-10/h"},
        {k:"2¬™ Hora", unit:"mm/h", normal:"Hombres:0-15/h, [[br]]Mujer:0-20/h, [[br]]Ni√±os:0-10/h"}
      ]},
      reticulocitos: {title:"RETICULOCITOS", params:[
        {k:"Conteo de Reticulocitos", unit:"%", normal:"0.5 - 2.0"}
      ]},
      lamina: {
        title: "LAMINA PERIFERICA",
        params: [
          {k: "GLOBULOS ROJOS", unit: "", normal: "", type: "text", readonly: true},
          {k: "Tama√±o", unit: "", normal: "", type: "select", options: ["Normal", "Microc√≠tica", "Macroc√≠tica", "Normoc√≠tica"]},
          {k: "Forma", unit: "", normal: "", type: "select", options: ["Normal", "Anisocitosis", "Poiquilocitosis", "Mixtas"]},
          {k: "Color", unit: "", normal: "", type: "select", options: ["Normal", "Hipocr√≥mico", "Hipercrom√°tico", "Policrom√°tico"]},
          {k: "Presencia de inclusiones", unit: "", normal: "", type: "select", options: ["Ausentes", "Howell-Jolly", "Punteado bas√≥filo", "Cuerpos de Heinz"]},
          {k: "GLOBULOS BLANCOS (Recuento diferencial)", unit: "", normal: "", type: "text", readonly: true},
          {k: "Neutr√≥filos (segmentados, bandas)", unit:"%", normal:"55 - 65"},
          {k: "Linfocitos", unit:"%", normal:"23 - 35"},
          {k: "Monocitos", unit:"%", normal:"4 - 8"},
          {k: "Eosin√≥filos", unit:"%", normal:"0.5 - 4"},
          {k: "Bas√≥filos", unit:"%", normal:"0 - 2"},
          {k: "Morfolog√≠a de cada tipo celular", unit: "", normal: "", type: "text", placeholder: "Ej: Neutr√≥filos con toxicidad moderada"},
          {k: "PLAQUETAS", unit: "", normal: "", type: "text", readonly: true},
          {k: "Tama√±o", unit: "", normal: "", type: "select", options: ["Normal", "Peque√±as", "Grandes", "Variado"]},
          {k: "Agregaci√≥n", unit: "", normal: "", type: "select", options: ["Normal", "Disminuida", "Aumentada"]},
          {k: "Comentario final/Conclusi√≥n", unit: "", normal: "", type: "text", placeholder: "Conclusi√≥n final de la l√°mina perif√©rica"}
        ]
      },
      tipo_sangre: {title:"TIPO DE SANGRE", params:[
        {k:"Grupo ABO", unit:"", normal:"A/B/AB/O", type:"select", options:["A","B","AB","O"]},
        {k:"Factor RH", unit:"", normal:"Positivo/Negativo", type:"select", options:["Positivo","Negativo"]}
      ]},
      hemoglobina: {title:"ELECTROFORESIS CUANTITATIVA DE HEMOGLOBINA", params:[
        {k:"Hemoglobina A1 HbA1", unit:"%", normal:"95-98"},
        {k:"Hemoglobina A2 HbA2", unit:"%", normal:"2-3"},
        {k:"Hemoglobina F HbF", unit:"%", normal:"Menos del 1-2"},
        {k:"Hemoglobina E HbE", unit:"%", normal:"Ausente"},
        {k:"Hemoglobina C HbC", unit:"%", normal:"Ausente"},
        {k:"Hemoglobina S HbS", unit:"%", normal:"Ausente"},
        {k:"Resultado Final", unit:"", normal:"", type:"select", options:["HbAA","HbAC","HbAS","HbSS","HbSC","HbCC"]},
        {k: "Comentarios/sugerencias ", unit: "", normal: "", type: "text", placeholder: ""}
      ]},
        hemoglobinaC: {title:"ELECTROFORESIS  CUALITATIVA DE HEMOGLOBINA", params:[
        {k:"Hemoglobina Cualitativa A HbA", unit:"", normal:"", type: "select", options:["Presente","Ausente"]},
        {k:"Hemoglobina Cualitativa C HbC", unit:"", normal:"", type: "select", options:["Presente","Ausente"]},
        {k:"Hemoglobina Cualitativa S HbS", unit:"", normal:"", type: "select", options:["Presente","Ausente"]},
        {k:"Resultado Final", unit:"", normal:"", type:"select", options:["HbAA","HbAC","HbAS","HbSS","HbSC","HbCC"]},
        {k: "Comentarios/sugerencias ", unit: "", normal: "", type: "text", placeholder: ""}
      ]}
    }
  },
  inmunologia: {
    id:"inmunologia", icon:"üî¨", title:"INMUNOLOGIA / MARCADORES TUMORALES",
    sections:{
      tumorales: {title:"MARCADORES TUMORALES", params:[
        {k:"PSA - TOTAL", unit:"ng/mL", normal:"< 4"},
        {k:"PSA - LIBRE", unit:"ng/mL", normal:"0.0 - 1.5"},
        {k:"ALFA-FETOPROTEINA (AFP)", unit:"ng/mL", normal:"< 10"},
        {k:"ANTIGENO CARCINOEMBRIONARIO (CEA)", unit:"ng/mL", normal:"< 5"},
        {k:"ANTIGENO CARBOHIDRATO 125 (CA 125)", unit:"U/mL", normal:"< 35"},
        {k:"ANTIGENO CARBOHIDRATO 19.9 (CA 19.9)", unit:"U/mL", normal:"< 37"},
        {k:"ANTIGENO CARBOHIDRATO 15.3 (CA 15.3)", unit:"U/mL", normal:"< 35"},
        {k:"ANTIGENO CARBOHIDRATO 72.4 (CA 72.4)", unit:"U/mL", normal:"< 6"},
        {k:"Hepatitis B / (HBsAg)-Determinaci√≥n cuantitativa del ant√≠geno de superficie", unit:"COI", normal:"< 0.90 (Negativo) [[br]]‚â•0.90 a < 1.0 (Lim√≠trofe/Indeterminado) [[br]]‚â• 1.0 (Positivo)", type:"text"},
        {k:"Hepatitis C / (VHC)-Determinaci√≥n cuantitativa  del anticuerpo del virus", unit:"COI", normal:"< 0.90 (Negativo) [[br]]‚â•0.90 a < 1.0 (Lim√≠trofe/Indeterminado) [[br]]‚â• 1.0 (Positivo)", type:"text"}
      ]}
    }
  },
  parasitologia_gota: {
    id:"parasitologia_gota", icon:"ü¶†", title:"PARASITOLOGIA / MALARIA",
    sections:{
      malaria: {title:"Gota gruesa", params:[
        {k:"Gota gruesa / Extensi√≥n", unit:"", normal:"Negativo: No se observan formas parasitarias de Plasmodium.", type:"select", options:["Negativo","Positivo"]},
        {k:"Densidad parasitaria", unit:"", normal:"Positivo:[[br]]+ = 1 ‚Äì 10 parasito por 100 campos[[br]]++ = 11-100 parasito por 100 campos[[br]]+++ = 1 ‚Äì 10 par√°sitos en un solo campo[[br]]++++ =  > 10 par√°sitos en un solo campo.", type:"select", options:["Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"]},
        {k:"Especie", unit:"", normal:"", type:"select", options:["Plasmodium falciparum","Plasmodium vivax","Plasmodium malariae","Plasmodium ovale","No identificado"]}
      ]}
    }
  },
  parasitologia_heces: {
    id:"parasitologia_heces", icon:"üí©", title:"PARASITOLOGIA / HECES",
    sections:{
      coprologico: {title:"Coprol√≥gico", params:[
        {k:"M√©todo", unit:"", normal:"", type:"select", options:["Preparaci√≥n directa"]},
        {k:"Color", unit:"", normal:"", type:"select", options:["Marr√≥n","Amarillo","Verde","Negro","Rojizo","Blanquecino"]},
        {k:"Consistencia", unit:"", normal:"", type:"select", options:["Formada","Blanda","L√≠quida","Dura","Pastosa"]},
        {k:"Moco", unit:"", normal:"Informacion complemetaria", type:"select", options:["Ausente","Escaso","Moderado","Abundante"]},
        {k:"Sangre", unit:"", normal:"Informacion complemetaria", type:"select", options:["Ausente","Escasa","Moderada","Abundante"]},
        {k:"Resultado", unit:"", normal:" Negativo/No se observa ninguna etapa parasitaria", type:"select", options:["Negativo"]},
        {k:"Resultado Heces", unit:"", normal:"Positivo (presencia de huevo, quiste, trofozoito o larva)", type:"select", options:["Positivo"]},
        {k:"Especie", unit:"", normal:"", type:"select", options:["Ascaris lumbricoides","Trichuris trichiura","Enterobius vermicularis","Taenia solium","Taenia saginata","Hymenolepis nana","Giardia lamblia","Entamoeba histolytica","Cryptosporidium","Balantidium coli","Candidas (+)","Candidas (++)","Candidas (+++)"]},
        {k:"Etapa", unit:"", normal:"", type:"select", options:["Huevo","Quiste","Trofozoito","Larva","Adulto"]},
        {k:"Cantidad", unit:"", normal:"", type:"select", options:["Escasos","Moderados","Abundantes"]},
        { k:"Otros hallazgos", unit:"", normal:"", type:"text", placeholder:"Cualquier otro hallazgo" }
      ]}
    }
  },
  exudado: {
    id:"exudado", icon:"üß´", title:"EXUDADO VAGINAL",
    sections:{
      fresco: {title:"Examen fresco", params:[
        {k:"C√©lulas epiteliales", unit:"", normal:"Ausente/Escasas", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Leucocitos", unit:"", normal:"2-4/campo", type:"text"},
        {k:"Levaduras", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Trichomonas vaginalis", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Bacterias", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"C√©lulas clave/Clue cells", unit:"", normal:"No se observaron", type:"select", options:["Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Hemat√≠es", unit:"", normal:"Ausentes/No se observan", type:"text"},
        {k:"PH", unit:"", normal:"3.8 - 4.5", type:"text"},
        {k:"Test de Aminas", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]}
      ]},
      gram: {title:"Tinci√≥n de Gram", params:[
        {k:"Bacterias", unit:"", normal:"Resultados normales: Indican la ausencia de bacterias/levaduras. [[br]]Resultados anormales: La presencia de bacterias (cocos o bacilos), la forma de bacterias (cocos o bacilos), su agrupaci√≥n (cadenas o pares)  o presencia de levaduras.", type:"text", placeholder:"Ej: Gram positivas en cadenas"},
        {k:"Levaduras", unit:"", normal:"Resultados normales: Indican la ausencia de bacterias/levaduras. [[br]]Resultados anormales: La presencia de bacterias (cocos o bacilos), la forma de bacterias (cocos o bacilos), su agrupaci√≥n (cadenas o pares)  o presencia de levaduras.", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Clue cells", unit:"", normal:"No se observaron, escasas, moderadas o abundantes", type:"select", options:["No se observan","Escasas (+)","Moderadas (++)","Abundantes (+++)"]}
      ]},
      antigenos: {title:"Prueba de detecci√≥n de ant√≠genos", params:[
        {k:"Candida albicans", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Trichomonas vaginalis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Gardnerella vaginalis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Chlamydia trachomatis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Otros Hallazgos", unit:"", normal:"---------------", type:"text"},
        {k:"Diagnostico/comentario final:", unit:"", normal:"Normal: No se detectan signos de infecci√≥n o microorganismos anormales. ,[[br]]Anormal: Se reporta la presencia de bacterias, levaduras, trichomonas,chlamydia, c√©lulas clave, un recuento elevado de gl√≥bulos blancos, un pH elevado o un olor a pescado. ", type:"text"}
      ]}
    }
  },
   exudadoU:{
   id:"exudadoU", icon:"üß´", title:"EXUDADO URETRAL",
    sections:{
      frescoU: {title:"Examen fresco", params:[
        {k:"C√©lulas epiteliales", unit:"", normal:"Ausente/Escasas", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Leucocitos", unit:"", normal:"2-4/campo", type:"text"},
        {k:"Levaduras", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Trichomonas vaginalis", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Bacterias", unit:"", normal:"Ausentes/No se observan", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"C√©lulas clave/Clue cells", unit:"", normal:"No se observaron", type:"select", options:["Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Hemat√≠es", unit:"", normal:"Ausentes/No se observan", type:"text"},
        {k:"PH", unit:"", normal:"3.8 - 4.5", type:"text"},
        {k:"Test de Aminas", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]}
      ]},
      gramU: {title:"Tinci√≥n de Gram", params:[
        {k:"Bacterias", unit:"", normal:"Resultados normales: Indican la ausencia de bacterias/levaduras. [[br]]Resultados anormales: La presencia de bacterias (cocos o bacilos), su agrupaci√≥n (cadenas o pares)  o presencia de levaduras.", type:"text", placeholder:"Ej: Gram positivas en cadenas"},
        {k:"Levaduras", unit:"", normal:"Resultados normales: Indican la ausencia de bacterias/levaduras. [[br]]Resultados anormales: La presencia de bacterias (cocos o bacilos), su agrupaci√≥n (cadenas o pares)  o presencia de levaduras.", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"]},
        {k:"Clue cells", unit:"", normal:"No se observaron, escasas, moderadas o abundantes", type:"select", options:["No se observan","Escasas (+)","Moderadas (++)","Abundantes (+++)"]}
      ]},
      antigenosU: {title:"Prueba de detecci√≥n de ant√≠genos", params:[
        {k:"Candida albicans", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Trichomonas vaginalis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Gardnerella vaginalis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Chlamydia trachomatis", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Otros Hallazgos", unit:"", normal:"---------------", type:"text"},
        {k:"Diagnostico/comentario final:", unit:"", normal:"Normal: No se detectan signos de infecci√≥n o microorganismos anormales. ,[[br]]Anormal: Se reporta la presencia de bacterias, levaduras, trichomonas,chlamydia, c√©lulas clave, un recuento elevado de gl√≥bulos blancos, un pH elevado o un olor a pescado. ", type:"text"}
      ]}
    } 
   },

  urinalysis: {
    id:"urinalysis", icon:"üß™", title:"ORINA",
    sections:{
      macroscopico: {title:"I. Macrosc√≥pico", params:[
        {k: "Color",unit: "",normal: "Amarillo claro/√°mbar",type: "select",options: ["Transparente","Amarillo p√°lido","Amarillo claro","√Åmbar","Naranja","Marr√≥n oscuro","Rojizo/Rosa","Verde/Azul","Turbio/Lechoso","Negro","Otro"],bind: "colorMacro"},
        /*{k: "Color",unit: "",normal: "",type: "text",depends: {field: "colorMacro",value: "Otro"}},*/
        {k:"Aspecto", unit:"", normal:"Transparente/Claro", type:"select", options:["Transparente","Claro","Turbio","Poco turbio","muy turbio","Opalescente"]},
      ]},
      quimico: {title:"II. Qu√≠mico", params:[
        {k:"Gravedad Espec√≠fica", unit:"", normal:"1.003-1.035", type:"text"},
        {k:"pH", unit:"", normal:"5.0-7.0", type:"text"},
        {k:"Leucocitos", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)","Traza"]},
        {k:"Nitratos", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo"]},
        {k:"Prote√≠nas", unit:"", normal:"Negativo (< 10 mg/dL)", type:"select", options:["Negativo","Traza","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"]},
        {k:"Glucosa", unit:"", normal:"Normal", type:"select", options:["Normal","Anormal","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"]},
        {k:"Cetonas", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"]},
        { k:"Urobilin√≥geno", unit:"", normal:"Normal", type:"select", options:["Normal","Elevado","Bajo","Positivo (+)","Positivo (++)","Positivo (+++)","Otro"], bind:"urobilinogeno" },
        { k:"Bilirrubina", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"] },
        { k:"Sangre", unit:"", normal:"Negativo", type:"select", options:["Negativo","Positivo","Hem√≥lisis","Positivo (+)","Positivo (++)","Positivo (+++)","Positivo (++++)"] }
            ]},
      microscopico: { title:"III. Microsc√≥pico", params:[
        { k:"Leucitos", unit:"", normal:"0-5 por campo", type:"text" },
        { k:"Eritrocitos", unit:"", normal:"0-2 por campo", type:"text" },
        { k:"C√©lulas Epiteliales", unit:"", normal:"Ausentes/Escasas", type:"select", options:["Ausentes","Escasas","Moderadas","Abundantes"] },
        { k:"Bacteria", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"] },
        { k:"Trichomonas", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"] },
        { k:"Levaduras", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Escasas (+)","Moderadas (++)","Abundantes (+++)"] },
        { k:"Cristales", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Oxalato","Fosfatos","Urato","Cistina"] },
        { k:"Cilindros", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Hialinos","Granulosos","Leucocitarios","Eritrocitarios"] },
        { k:"Filamento mucoso", unit:"", normal:"Ausentes", type:"select", options:["Ausentes","Escasos","Moderados","Abundantes"] },
        { k:"Otros hallazgos", unit:"", normal:"", type:"text", placeholder:"Cualquier otro hallazgo" }
            ]}
    }
  },
  pruebas_rapidas: {
    id:"pruebas_rapidas", icon:"‚ö°", title:"INMUNOLOGIA RAPIDA",
    sections:{
      PruebasRapidas: { title:"Pruebas Rapidas", params:[
        { k:"Chlamydia trachomatis", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo"] },
        { k:"Rubeola", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo"] },
        { k:"Salmonella/Tifoidea", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo"] },
        { k:"Toxoplasmosis", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo"] },
        { k:"Tuberculosis", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo"] },
        { k:"Helicobacter pylori", unit:"", normal:"", type:"select", options:["IgG Positivo","IgM Positivo","IgG e IgM Positivos","Negativo","Positivo"] },
        { k:"Troponina", unit:"", normal:"", type:"select", options:["Positivo","Negativo"] },
        { k:"Factor Reumatoide (FR)", unit:"", normal:"", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)"] },
        { k:"Antiestreptolisina O (ASO)", unit:"", normal:"", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)"] },
        { k:"Prote√≠na C Reactiva cualitativa (PCR)", unit:"", normal:"", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)"] },
        { k:"Sangre oculta en heces fecales (FOB)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
        { k:"Embarazo/hormona Gonadotropina Cori√≥nica Humana (hCG)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
        { k:"Hepatitis B / (HBsAg)-Detecci√≥n cualitativa del ant√≠geno de Superficie", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
        { k:"Hepatitis C / (VHC)-Detecci√≥n cualitativa del anticuerpo del virus", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
        { k:"Brucella abortus", unit:"", normal:"", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)"] },
        { k:"VIH (Virus de Inmunodeficiencia Humana) / Detecci√≥n cualitativa del anticuerpo de VIH", unit:"", normal:"", type:"select", options:["Negativo"] },
        { k:"VIH (Virus de Inmunodeficiencia Humana) / Confirmaci√≥n cualitativa del anticuerpo de VIH", unit:"", normal:"Resultado confirmado: [[br]]PRUEBA DE DETERMINE -  VIH[[br]]PRUEBA DE UNI-GOLD  - VIH[[br]]PRUEBA DE BIOLINE ABOTT - VIH", type:"select", options:["POSITIVO - TIPO 1","POSITIVO - TIPO 2","POSITIVO - TIPO 1 y 2"] },
        { k:"S√≠filis / Prueba Trepon√©mica (Determinaci√≥n de anticuerpos)-PT", unit:"", normal:"PT (+) y PNT (+): sugiere una infecci√≥n de s√≠filis activa. [[br]]PT (+) y PNT (-): sugiere una infecci√≥n de s√≠filis reciente o tratada. [[br]]PT (-) y PNT (-): Indica ausencia de infecci√≥n por s√≠filis.", type:"select", options:["Negativo","Positivo"] },
        { k:"S√≠filis / Prueba no Trepon√©mica (RPR)-PNT", unit:"", normal:"PT (+) y PNT (+): sugiere una infecci√≥n de s√≠filis activa. [[br]]PT (+) y PNT (-): sugiere una infecci√≥n de s√≠filis reciente o tratada. [[br]]PT (-) y PNT (-): Indica ausencia de infecci√≥n por s√≠filis.", type:"select", options:["Negativo","Positivo (+)","Positivo (++)","Positivo (+++)"] }
            ]}
            }
        },
  drogas: {
    id:"drogas", icon:"üíä", title:"TEST-ABUSO DE DROGAS EN ORINA",
    sections:{
      panel_drogas: { title:"Panel de Drogas", params:[
{ k:"Anfetamina (AMP)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Etilglucur√≥nido (ETG)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Metanfetamina (MET)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Coca√≠na (COC)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"D-Amphetamine (MAMP)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Morfina (MOR)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Marihuana (THC)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Benzodiacepina (BZD/BZO)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Barbit√∫ricos (BAR)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"√âxtasis (XTC)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Fenciclidina (PCP)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Methadone (MTD)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] },
{ k:"Tricyclic Antidepressant (TCA)", unit:"", normal:"", type:"select", options:["Negativo","Positivo"] }
      ]}
    }
  },
  diabetis: {
    id:"diabetis", icon:"ü©∏üç¨", title:"ESTUDIO DE DIABETIS",
    sections:{
      glucosa: { title:"Curva de Tolerancia a la Glucosa - en Ayunas y Post Carga", params:[
{ k:"Glicemia en ayunas/basal", unit:"mg/dL", normal:"<105(Mujer Embarazada)", type:"text" },
{ k:"Glicemia a la primera hora post carga de 75 grs", unit:"mg/dL", normal:"‚â§180", type:"text" },
{ k:"Glicemia a la segunda hora post carga 75 grs", unit:"mg/dL", normal:"<140", type:"text" }
      ]},
      glicemia: { title:"Determinaci√≥n de Glicemia en Ayunas y Post Prandial", params:[
{ k:"Glicemia en ayunas", unit:"mg/dL", normal:"<100", type:"text" },
{ k:"Glicemia postprandial (2 horas despu√©s de comer)", unit:"mg/dL", normal:"<140", type:"text" }
      ]}
    }
  }
};

const state = {
  selectedReports: new Set(['hematologia']),
  selectedSections: {},
  selectedParams: {}
};

Object.keys(REPORTS).forEach(r => {
  state.selectedSections[r] = new Set();
  state.selectedParams[r] = {};
  Object.keys(REPORTS[r].sections).forEach(s => {
    state.selectedParams[r][s] = new Set();
  });
});

const DB_NAME = 'onlyone_pro_db';
const STORE_REPORTS = 'saved_reports';
const STORE_HISTORY = 'report_history';
let dbInstance = null;

const reportsGrid = document.getElementById('reportsGrid');
const sectionsContainer = document.getElementById('sectionsContainer');
const paramsContainer = document.getElementById('paramsContainer');
const btnOpenPreview = document.getElementById('btnOpenPreview');
const btnOpenPreview2 = document.getElementById('btnOpenPreview2');
const modalPreview = document.getElementById('modalPreview');
const previewFrame = document.getElementById('previewFrame');
const modalClose = document.getElementById('modalClose');
const modalPrint = document.getElementById('modalPrint');
const btnNew = document.getElementById('btnNew');
const btnRestore = document.getElementById('btnRestore');
const selectAllSections = document.getElementById('selectAllSections');
const deselectAllSections = document.getElementById('deselectAllSections');
const statusBox = document.getElementById('statusBox');
const sigCanvas = document.getElementById('sigCanvas');
const sigCtx = sigCanvas.getContext('2d');
const importJSONFile = document.getElementById('importJSONFile');

let drawing=false, lastX=0, lastY=0;
sigCtx.strokeStyle = "#0b3954";
sigCtx.lineWidth = 2;
sigCtx.lineJoin = 'round';
sigCtx.lineCap = 'round';
let savedSigDataUrl = '';

function openDB(){
  return new Promise((resolve, reject) => {
    if(dbInstance) return resolve(dbInstance);
    const req = indexedDB.open(DB_NAME, 2);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_REPORTS)){
        db.createObjectStore(STORE_REPORTS, { keyPath: 'id' });
      }
      if(!db.objectStoreNames.contains(STORE_HISTORY)){
        const historyStore = db.createObjectStore(STORE_HISTORY, { keyPath: 'id', autoIncrement: true });
        historyStore.createIndex('fecha', 'fechaGeneracion', { unique: false });
        historyStore.createIndex('profesional', 'profesional.nombre', { unique: false });
      }
    };
    req.onsuccess = (e) => { dbInstance = e.target.result; resolve(dbInstance); };
    req.onerror = (e) => { reject(e.target.error); };
  });
}

async function guardarInformeEnHistorial() {
  try {
    const db = await openDB();
    const informeData = buildCombinedJSON();
    const registroHistorial = {
      id: Date.now(),
      fechaGeneracion: new Date().toISOString(),
      datosPaciente: informeData.meta.paciente,
      informesSeleccionados: informeData.informes.map(i => ({
        id: i.id,
        titulo: i.title,
        secciones: i.secciones.map(s => ({
          id: s.id,
          titulo: s.title,
          cantidadParametros: s.parametros.length
        }))
      })),
      profesional: informeData.meta.profesional,
      notas: informeData.meta.notas,
      totalParametros: informeData.informes.reduce((total, inf) => 
        total + inf.secciones.reduce((sum, sec) => sum + sec.parametros.length, 0), 0)
    };

    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_HISTORY, 'readwrite');
      const store = tx.objectStore(STORE_HISTORY);
      store.add(registroHistorial);
      tx.oncomplete = () => { 
        statusBox.textContent = 'Informe guardado en historial';
        actualizarContador();
        resolve(true); 
      };
      tx.onerror = (e) => { 
        statusBox.textContent = 'Error al guardar en historial';
        reject(e.target.error); 
      };
    });
  } catch (error) {
    console.error('Error en guardarInformeEnHistorial:', error);
    statusBox.textContent = 'Error al guardar historial';
  }
}


document.getElementById('sigFile').addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const img = new Image();
    img.onload = function(){
      sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
      sigCtx.drawImage(img, 0, 0, sigCanvas.width, sigCanvas.height);
      savedSigDataUrl = sigCanvas.toDataURL('image/png');
      statusBox.textContent = 'Firma cargada';
    };
    img.src = ev.target.result;
  };
  reader.readAsDataURL(f);
});

function startDraw(e){
  drawing = true;
  const rect = sigCanvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  lastX = x; lastY = y;
}

function draw(e){
  if(!drawing) return;
  const rect = sigCanvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  sigCtx.beginPath();
  sigCtx.moveTo(lastX, lastY);
  sigCtx.lineTo(x, y);
  sigCtx.stroke();
  lastX = x; lastY = y;
}

function endDraw(){ drawing=false; }

sigCanvas.addEventListener('mousedown', startDraw);
sigCanvas.addEventListener('touchstart', startDraw);
sigCanvas.addEventListener('mousemove', draw);
sigCanvas.addEventListener('touchmove', draw, {passive:false});
sigCanvas.addEventListener('mouseup', endDraw);
sigCanvas.addEventListener('mouseout', endDraw);
sigCanvas.addEventListener('touchend', endDraw);

document.getElementById('clearSig').addEventListener('click', ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  savedSigDataUrl='';
});

document.getElementById('saveSig').addEventListener('click', ()=>{
  savedSigDataUrl = sigCanvas.toDataURL('image/png');
  alert('Firma guardada para el informe (aparecer√° en la vista previa/PDF).');
});

function renderReports(){
  reportsGrid.innerHTML = '';
  Object.values(REPORTS).forEach(r=>{
    const el = document.createElement('div');
    el.className = 'report-card ' + (state.selectedReports.has(r.id) ? '' : 'inactive');
    el.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="font-size:22px">${r.icon}</div>
        <div style="flex:1"><h3 style="margin:0">${r.title}</h3><div class="small">${Object.keys(r.sections).length} secciones</div></div>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <label class="checkbox"><input type="checkbox" class="report-chk" data-report="${r.id}" ${state.selectedReports.has(r.id)?'checked':''}></label>
        </div>
      </div>`;
    reportsGrid.appendChild(el);
  });
  reportsGrid.querySelectorAll('.report-chk').forEach(cb=>{
    cb.addEventListener('change', e=>{
      const id = e.target.dataset.report;
      if(e.target.checked) state.selectedReports.add(id);
      else {
        state.selectedReports.delete(id);
        state.selectedSections[id] = new Set();
        Object.keys(REPORTS[id].sections).forEach(sid => state.selectedParams[id][sid] = new Set());
      }
      renderAll();
    });
  });
}

function renderSectionSelectors(){
  sectionsContainer.innerHTML = '';

  const mainAccordion = document.createElement('div');
  mainAccordion.className = 'sections-accordion';
  mainAccordion.style.cssText = 'padding:0;margin:0';

  Object.values(REPORTS).forEach(r=>{
    const reportAccordion = document.createElement('div');
    reportAccordion.className = 'accordion-item';
    reportAccordion.style.borderBottom = '1px solid #e6eef8';
    reportAccordion.style.marginBottom = '8px';

    const header = document.createElement('div');
    header.className = 'accordion-header-report';
    header.style.cssText = `
      padding: 12px;
      background: linear-gradient(90deg, #00c0c6 0%, #44f0e8 60%, #9ef6f6 100%);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      transition: all 0.18s ease;
      border-radius: 6px;
    `;

    const isReportActive = state.selectedReports.has(r.id);
    const statusColor = isReportActive ? '#0f9d8e' : '#999';
    const statusText = isReportActive ? '‚úì Activo' : '‚óã Inactivo';

    header.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center;flex:1">
        <span style="font-size:18px">${r.icon}</span>
        <strong style="color:#0b3954">${r.title}</strong>
        <span style="font-size:12px;color:${statusColor};font-weight:600;margin-left:8px">${statusText}</span>
        <span style="font-size:12px;color:#999;margin-left:10px">(${Object.keys(r.sections).length} secciones)</span>
      </div>
      <span class="accordion-toggle-report" style="font-size:18px;transition:transform 0.18s">${isReportActive ? '‚ñæ' : '‚ñ∏'}</span>
    `;

    const content = document.createElement('div');
    content.className = 'accordion-content-sections';
    content.style.cssText = `
      padding: 0 0 10px 0;
      max-height: 420px;
      overflow-y: auto;
      display: ${isReportActive ? 'block' : 'none'};
      background: transparent;
      margin-top: 8px;
    `;

    const sectionsWrapper = document.createElement('div');
    sectionsWrapper.style.cssText = 'padding: 8px 12px; display: flex; flex-direction: column; gap: 8px;';

    if (!isReportActive) {
      const hint = document.createElement('div');
      hint.style.cssText = 'padding:10px;color:#666;font-size:13px';
      hint.textContent = 'Activa el informe (clic en el header o en "Seleccionar informe") para ver sus secciones.';
      sectionsWrapper.appendChild(hint);
    }

    if (Object.keys(r.sections).length > 0) {
      const selectAllBtn = document.createElement('button');
      selectAllBtn.className = 'select-all';
      selectAllBtn.textContent = '‚òë Seleccionar todas las secciones';
      selectAllBtn.style.cssText = `
        background: linear-gradient(90deg,#0ba4dc,#0f9d8e);
        color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer;font-weight:600;
      `;
      selectAllBtn.addEventListener('click', e=>{
        if(!state.selectedReports.has(r.id)){ alert('Activa el informe primero'); return; }
        Object.keys(r.sections).forEach(sid => state.selectedSections[r.id].add(sid));
        renderAll();
        saveAppState();
      });
      sectionsWrapper.appendChild(selectAllBtn);
    }

    Object.entries(r.sections).forEach(([sid,s])=>{
      const lab = document.createElement('label');
      lab.className = 'sect-item-accordion';
      lab.style.cssText = `
        display:flex;align-items:center;gap:10px;padding:10px;border-radius:6px;
        background:#fff;border:1px solid #eaf6ff;cursor:pointer;
      `;

      const isChecked = state.selectedSections[r.id].has(sid);
      const isDisabled = !state.selectedReports.has(r.id);

      lab.innerHTML = `
        <input type="checkbox" data-report="${r.id}" data-section="${sid}" ${isChecked?'checked':''} ${isDisabled?'disabled':''} style="cursor:pointer;width:18px;height:18px">
        <span style="flex:1;font-weight:500;color:#0b3954">${escapeHtml(s.title)}</span>
        <span style="font-size:11px;color:#999">${s.params.length} par√°metros</span>
      `;

      if (isDisabled) {
        lab.style.opacity = '0.5';
        lab.style.pointerEvents = 'none';
      }

      lab.addEventListener('mouseenter', () => { if(!isDisabled) lab.style.background = '#f3fbff'; });
      lab.addEventListener('mouseleave', () => { if(!isDisabled) lab.style.background = 'white'; });

      sectionsWrapper.appendChild(lab);
    });

    content.appendChild(sectionsWrapper);

    header.addEventListener('click', () => {
      const wasActive = state.selectedReports.has(r.id);
      if (!wasActive) {
        state.selectedReports.add(r.id);
        if (!state.selectedSections[r.id]) state.selectedSections[r.id] = new Set();
        if (!state.selectedParams[r.id]) {
          state.selectedParams[r.id] = {};
          Object.keys(REPORTS[r.id].sections).forEach(sid => state.selectedParams[r.id][sid] = new Set());
        }
        saveAppState();
        renderAll();
        return;
      }
      const isOpen = content.style.display === 'block';
      content.style.display = isOpen ? 'none' : 'block';
      const toggle = header.querySelector('.accordion-toggle-report');
      toggle.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
    });

    reportAccordion.appendChild(header);
    reportAccordion.appendChild(content);
    mainAccordion.appendChild(reportAccordion);
  });

  sectionsContainer.appendChild(mainAccordion);

  sectionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.onchange = null;
    cb.addEventListener('change', e=>{
      const rep = e.target.dataset.report;
      const sec = e.target.dataset.section;
      if(e.target.checked) state.selectedSections[rep].add(sec);
      else {
        state.selectedSections[rep].delete(sec);
        state.selectedParams[rep][sec] = new Set();
      }
      renderParameterForms();
      saveAppState();
    });
  });
}

function slugify(s){ 
  return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'').replace(/^|_$/g,''); 
}

// REEMPLAZA COMPLETAMENTE la funci√≥n renderParameterForms()

function renderParameterForms(){
  paramsContainer.innerHTML = '';
  
  const mainAccordion = document.createElement('div');
  mainAccordion.className = 'card';
  mainAccordion.style.padding = '0';
  
  Object.values(REPORTS).forEach(r => {
    const selected = Array.from(state.selectedSections[r.id]);
    if(selected.length === 0) return;
    
    selected.forEach(secId => {
      const sec = r.sections[secId];
      if(!sec) return;
      
      const sectionAccordion = document.createElement('div');
      sectionAccordion.className = 'accordion-item';
      sectionAccordion.style.borderBottom = '1px solid #e6eef8';
      
      const header = document.createElement('div');
      header.className = 'accordion-header';
      header.style.cssText = `
        padding: 14px;
        background: linear-gradient(90deg, #f38b02);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s ease;
      `;
      header.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;flex:1">
          <span style="font-size:18px">${r.icon}</span>
          <strong style="color:#00000">${r.title} ‚Üí ${sec.title}</strong>
          <span style="font-size:12px;color:#0f9d8e">(${sec.params.length} par√°metros)</span>
        </div>
        <span class="accordion-toggle" style="font-size:20px;transition:transform 0.2s">‚ñº</span>
      `;
      
      const content = document.createElement('div');
      content.className = 'accordion-content';
      content.style.cssText = `
        padding: 0;
        max-height: 500px;
        overflow-y: auto;
        display: none;
      `;
      
      const tbl = document.createElement('table');
      tbl.style.cssText = 'width:100%;border-collapse:separate;border-spacing:0;margin:0';
      
      // HEADER DE LA TABLA CON CHECKBOX SELECTALL
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.style.background = '#0f9d8e';
      
      const headerCell = document.createElement('th');
      headerCell.style.cssText = 'padding:8px;border-bottom:2px solid #0f9d8e;cursor:pointer;text-align:center';
      
      const selectAllCheckbox = document.createElement('input');
      selectAllCheckbox.type = 'checkbox';
      selectAllCheckbox.style.cssText = 'cursor:pointer;width:18px;height:18px';
      // ID √öNICO para cada secci√≥n
      selectAllCheckbox.id = `selectall_${r.id}_${secId}`;
      selectAllCheckbox.dataset.reportId = r.id;
      selectAllCheckbox.dataset.sectionId = secId;
      
      headerCell.appendChild(selectAllCheckbox);
      headerRow.appendChild(headerCell);
      
      const paramHeaderCell = document.createElement('th');
      paramHeaderCell.style.cssText = 'padding:8px;border-bottom:2px solid #0f9d8e';
      paramHeaderCell.textContent = 'PAR√ÅMETRO';
      headerRow.appendChild(paramHeaderCell);
      
      const resultHeaderCell = document.createElement('th');
      resultHeaderCell.style.cssText = 'padding:8px;border-bottom:2px solid #0b0b0b;text-align:center';
      resultHeaderCell.textContent = 'RESULTADO';
      headerRow.appendChild(resultHeaderCell);
      
      const unitHeaderCell = document.createElement('th');
      unitHeaderCell.style.cssText = 'padding:8px;border-bottom:2px solid #0b0b0b;text-align:center';
      unitHeaderCell.textContent = 'UNIDAD';
      headerRow.appendChild(unitHeaderCell);
      
      const normalHeaderCell = document.createElement('th');
      normalHeaderCell.style.cssText = 'padding:8px;border-bottom:2px solid #0b0b0b';
      normalHeaderCell.textContent = 'VALOR NORMAL/INTERPRETACION';
      headerRow.appendChild(normalHeaderCell);
      
      thead.appendChild(headerRow);
      tbl.appendChild(thead);
      
      const tbody = document.createElement('tbody');
      sec.params.forEach((p, idx) => {
        const idSafe = `inp_${r.id}_${secId}_${slugify(p.k)}`;
        const tr = document.createElement('tr');
        tr.style.borderBottom = '1px solid #edf5ff';
        let inputHtml = '';

        if (p.type === 'select' && p.options) {
          const storageKey = `custom_options_${r.id}_${secId}_${slugify(p.k)}`;
          let customOptions = JSON.parse(localStorage.getItem(storageKey) || '[]');
          let allOptions = [...new Set([...p.options, ...customOptions])];

          inputHtml = `
            <div style="display:flex;gap:6px;align-items:center">
              <select id="${idSafe}" class="param-input" style="flex:1;padding:8px;border-radius:6px;border:1px solid #d0eaf2" data-meta='${encodeURIComponent(JSON.stringify({report:r.id,section:secId,key:p.k,unit:p.unit,normal:p.normal}))}'>
                ${allOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
              </select>
              <div style="display:flex;gap:6px;align-items:center">
                <button type="button" class="btn-add-option" data-key="${storageKey}" data-target="${idSafe}" title="A√±adir nueva opci√≥n" style="background:#0f9d8e;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px">‚ûï</button>
                <button type="button" class="btn-remove-option" data-key="${storageKey}" data-target="${idSafe}" title="Eliminar opci√≥n personalizada" style="background:#dc3545;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px">üóëÔ∏è</button>
              </div>
            </div>`;
        } else {
          inputHtml = `<input id="${idSafe}" class="param-input" type="${p.type||'text'}" ${p.readonly?'readonly':''} placeholder="${p.placeholder||''}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #d0eaf2" data-meta='${encodeURIComponent(JSON.stringify({report:r.id,section:secId,key:p.k,unit:p.unit,normal:p.normal}))}'>`;
        }

        const checked = state.selectedParams[r.id][secId].has(p.k) ? 'checked' : '';
        const paramCheckboxId = `param_${r.id}_${secId}_${idx}`;
        
        tr.innerHTML = `
          <td style="padding:8px;text-align:center"><input type="checkbox" id="${paramCheckboxId}" data-report="${r.id}" data-section="${secId}" data-param="${p.k}" ${checked}></td>
          <td style="padding:8px"><strong>${escapeHtml(p.k)}</strong></td>
          <td style="padding:8px">${inputHtml}</td>
          <td style="padding:8px;text-align:center"><strong>${escapeHtml(p.unit||'')}</strong></td>
          <td style="padding:8px"><strong>${escapeHtml((p.normal||'').replace(/\[\[br\]\]/g, '<br>'))}</strong></td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);
      content.appendChild(tbl);
      
      header.addEventListener('click', () => {
        const isOpen = content.style.display === 'block';
        content.style.display = isOpen ? 'none' : 'block';
        const toggle = header.querySelector('.accordion-toggle');
        toggle.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
      });
      
      header.addEventListener('mouseenter', () => {
        header.style.background = 'linear-gradient(90deg, #0d8872, #e6f3ff)';
      });
      header.addEventListener('mouseleave', () => {
        header.style.background = 'linear-gradient(90deg, #0d8872, #f1f8ff)';
      });
      
      sectionAccordion.appendChild(header);
      sectionAccordion.appendChild(content);
      mainAccordion.appendChild(sectionAccordion);
    });
  });
  
  paramsContainer.appendChild(mainAccordion);
  
  // ===== EVENTOS: CHECKBOXES DE PAR√ÅMETROS INDIVIDUALES =====
  paramsContainer.querySelectorAll('input[id^="param_"]').forEach(paramCb => {
    paramCb.addEventListener('change', (e) => {
      const rep = e.target.dataset.report;
      const sec = e.target.dataset.section;
      const param = e.target.dataset.param;
      
      if (e.target.checked) {
        state.selectedParams[rep][sec].add(param);
      } else {
        state.selectedParams[rep][sec].delete(param);
      }
      
      // Actualizar selectAll checkbox
      const selectAllCb = document.getElementById(`selectall_${rep}_${sec}`);
      const allParamCbs = paramsContainer.querySelectorAll(`input[id^="param_${rep}_${sec}_"]`);
      
      if (selectAllCb && allParamCbs.length > 0) {
        const allChecked = Array.from(allParamCbs).every(cb => cb.checked);
        const someChecked = Array.from(allParamCbs).some(cb => cb.checked);
        
        selectAllCb.checked = allChecked;
        selectAllCb.indeterminate = someChecked && !allChecked;
      }
      
      saveAppState();
    });
  });
  
  // ===== EVENTO: CHECKBOX SELECTALL DE LA TABLA =====
  paramsContainer.querySelectorAll('input[id^="selectall_"]').forEach(selectAllCb => {
    selectAllCb.addEventListener('change', (e) => {
      const reportId = e.target.dataset.reportId;
      const sectionId = e.target.dataset.sectionId;
      const isChecked = e.target.checked;
      
      console.log(`SelectAll: ${reportId} - ${sectionId}, Checked: ${isChecked}`);
      
      // Obtener TODOS los checkboxes de par√°metros de esta secci√≥n
      const paramCheckboxes = paramsContainer.querySelectorAll(`input[id^="param_${reportId}_${sectionId}_"]`);
      
      console.log(`Encontrados ${paramCheckboxes.length} par√°metros para marcar/desmarcar`);
      
      paramCheckboxes.forEach(cb => {
        cb.checked = isChecked;
        // Disparar evento change para actualizar state
        cb.dispatchEvent(new Event('change', { bubbles: true }));
      });
    });
  });

  // ===== BOTONES AGREGAR/ELIMINAR OPCIONES PERSONALIZADAS =====
  paramsContainer.querySelectorAll('.btn-add-option').forEach(btn=>{
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      const targetId = btn.dataset.target;
      const select = document.getElementById(targetId);
      const newOption = prompt('Escribe la nueva opci√≥n a a√±adir:');
      if (!newOption || !newOption.trim()) return;
      
      const optionValue = newOption.trim();
      const existing = Array.from(select.options).map(o => o.value);
      if (existing.includes(optionValue)) {
        alert('Esta opci√≥n ya existe.');
        return;
      }

      const option = document.createElement('option');
      option.value = optionValue;
      option.textContent = optionValue;
      select.appendChild(option);
      select.value = optionValue;

      let stored = JSON.parse(localStorage.getItem(key) || '[]');
      stored.push(optionValue);
      localStorage.setItem(key, JSON.stringify(stored));
    });
  });

  paramsContainer.querySelectorAll('.btn-remove-option').forEach(btn=>{
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      const targetId = btn.dataset.target;
      const select = document.getElementById(targetId);
      if (!select) return;
      const selected = select.value;
      if (!selected) { alert('Selecciona la opci√≥n a eliminar en el desplegable.'); return; }

      let stored = JSON.parse(localStorage.getItem(key) || '[]');
      if (!Array.isArray(stored) || stored.length === 0) {
        alert('No hay opciones personalizadas para eliminar.');
        return;
      }
      if (!stored.includes(selected)) {
        alert('No se puede eliminar una opci√≥n predeterminada.');
        return;
      }
      if (!confirm(`¬øEliminar la opci√≥n personalizada "${selected}"?`)) return;

      stored = stored.filter(o => o !== selected);
      localStorage.setItem(key, JSON.stringify(stored));

      const opt = Array.from(select.options).find(o => o.value === selected);
      if (opt) opt.remove();
      select.value = select.options.length ? select.options[0].value : '';

      if (typeof statusBox !== 'undefined' && statusBox) statusBox.textContent = 'Opci√≥n personalizada eliminada';
    });
  });
}

// ...existing code...

function generateQRCodeDataURL(data){
  if (typeof QRCode === 'undefined') {
    console.warn('Biblioteca QRCode no disponible en este contexto');
    return '';
  }
  try {
    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'fixed';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '-9999px';
    document.body.appendChild(tempContainer);

    const qr = new QRCode(tempContainer, {
      text: data,
      width: 96,
      height: 96,
      colorDark: '#0b3954',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.H
    });

    if (qr.makeCode) {
      qr.makeCode(data);
    }

    const img = tempContainer.querySelector('img');
    const canvas = tempContainer.querySelector('canvas');
    let dataUrl = '';
    if (img && img.src) dataUrl = img.src;
    else if (canvas) dataUrl = canvas.toDataURL('image/png');

    tempContainer.remove();
    return dataUrl;
  } catch (err) {
    console.error('Error generando QR embebido:', err);
    return '';
  }
}

function buildCombinedHTML() {
  const LOGO = `<img src="LogoPrincipal.png" style="width:100px;height:92px;object-fit:contain;">`;
  const fecha = document.getElementById('p_fecha').value || new Date().toLocaleDateString();
  const historial = document.getElementById('p_historial').value || 'SN';
  const nombre = document.getElementById('p_nombre').value || '';
  const edad = document.getElementById('p_edad').value || '';
  const sexo = document.getElementById('p_sexo').value || '';
  const registro = document.getElementById('p_reg').value || '';
  const professional = document.getElementById('professionalSelect').value || '';
  const title = document.getElementById('professionalTitle').value || '';
  const notes = document.getElementById('finalNotes').value || '';
  const sig = savedSigDataUrl || sigCanvas.toDataURL();
  
  const css = `<style>
    @page { size: A4; margin: 6mm 8mm; }
    body{
      font-family:'Segoe UI',Arial,Helvetica,sans-serif;
      color:#0b3954;
      margin:0;
      padding:0;
      background:#fff;
      font-size:12px;
    }
    .paper{
      padding:8mm 10mm;
      max-width:210mm;
      margin:0 auto;
      background:#fff;
    }
    header{display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #0b3954;padding-bottom:10px;margin-bottom:12px}
    h1{margin:0;font-size:22px;color:#0b3954}
    .meta{font-size:12px;color:#555}
    .patient-box{background:#f4fbff;border-radius:8px;padding:8px;margin-bottom:12px;font-size:13px}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:5px;
      font-size:10px;
      border:2px solid #0b0b0b;
      border-radius:6px;
      background:#fff;
    }
    th,td{padding:3px 5px;text-align:left;font-size:10px;line-height:1.2;border:none}
    th{
      background:#f6f7fb;
      color:#0b0b0b;
      font-weight:700;
      border:1px solid #0b0b0b;
      border-radius:4px;
      box-shadow: inset 0 0 0 1px #ffffff;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .section{
      margin-bottom:16px;
      page-break-inside:avoid;
      break-inside:avoid;
    }
    .section h2{font-size:16px;color:#000000;margin:0 0 4px 0}
    .section h3{font-size:13px;color:#000000;margin:0 0 4px 0}
    .sig{
      margin-top:18px;
      border-top:2px dashed #d0e4f0;
      padding-top:10px;
      display:flex;
      gap:16px;
      align-items:center;
      font-weight:700;
    }
    .sig img{max-width:200px;height:auto;border:1px solid #d0e4f0;background:#fff;padding:4px;border-radius:6px}
    .notes{margin-top:10px;padding:10px;border-left:3px solid #0f9d8e;background:#f9fdff;font-size:12px}
    .final-block{page-break-inside:avoid;break-inside:avoid;margin-top:14px}
    footer{font-size:9px;color:#777;text-align:center;margin-top:6mm}
    @media print{
      body{padding:0;margin:0;font-size:11px;}
      .paper{margin:0 auto;padding:6mm 8mm;}
      th,td{font-size:9.5px;padding:2px 4px;}
      header{margin-bottom:8px;padding-bottom:8px;}
      .patient-box{margin-bottom:10px;padding:7px;font-size:12px;}
      .notes{font-size:11px;}
      .sig img{max-width:180px;}
      footer{margin-top:3mm;}
    }
  </style>`;

  let html = '<!doctype html><html><head><meta charset="utf-8"><title>Informe combinado</title>' + css + '</head><body>';
  html += `<div class="paper">`;
  html += `
    <header>
      <div style="display:flex;gap:15px;align-items:center;margin-bottom:20px;">
        <div style="width:100px;height:92px;">
          ${LOGO}
        </div>
        <div>
          <h1>CL√çNICA VIRGEN DE GUADALUPE</h1>
          <div class="meta">Calle Rey Malabo ¬∑ MALABO ¬∑ Tel/fax +240 333 099013</div>
        </div>
      </div>
      <div style="text-align:right">
        <div><strong>Fecha:</strong> ${escapeHtml(fecha)}</div>
        <div><strong>Generado:</strong> ${escapeHtml(new Date().toLocaleString())}</div>
      </div>
    </header>`;

  const informesSeleccionados = [];
  Object.values(REPORTS).forEach(r => {
    const secs = Array.from(state.selectedSections[r.id]);
    if(secs.length > 0) {
      informesSeleccionados.push({
        id: r.id,
        titulo: r.title,
        secciones: secs.map(secId => r.sections[secId].title)
      });
    }
  });

  const qrData = JSON.stringify({ f: fecha, h: historial, n: nombre, e: edad, s: sexo, r: registro });
  const qrImage = generateQRCodeDataURL(qrData);

  html += `
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:20px;">
      <div class="patient-box" style="flex:1; font-size:14px; line-height:1.3; min-height:90px; display:flex; flex-direction:column; justify-content:center;">
        <div style="display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between;">
          <div style="flex:1; min-width:220px;">
            |&nbsp;<strong>Historial:</strong> ${escapeHtml(historial)} &nbsp;<br><br>
            |&nbsp;<strong>Paciente:</strong> ${escapeHtml(nombre)} &nbsp;<br><br>
            |&nbsp;<strong>Edad:</strong> ${escapeHtml(edad)} &nbsp;
          </div>
          <div style="flex:1; min-width:220px; text-align:right; margin-left:auto;">
            |&nbsp;<strong>G√©nero:</strong> ${escapeHtml(sexo)} &nbsp;<br><br>
            |&nbsp;<strong>Registro:</strong> ${escapeHtml(registro)} &nbsp;
          </div>
        </div>
      </div>
      <div style="width:96px; height:96px; border:1px solid #d0e4f0; background:#fff; padding:4px; border-radius:6px; display:flex; align-items:center; justify-content:center;">
        ${qrImage ? `<img src="${qrImage}" alt="C√≥digo QR del paciente" style="width:100%;height:100%;object-fit:contain;">`
                   : `<div style="font-size:10px;color:#999;text-align:center;">QR<br>Code</div>`}
      </div>
    </div>`;
  html += `<div><center><h1>INFORME DE LABORATORIO CL√çNICO</h1></center></div><br>`;

  Object.values(REPORTS).forEach(r => {
    const sel = Array.from(state.selectedSections[r.id]);
    if (sel.length === 0) return;
    html += `<div class="section"><h2>${escapeHtml(r.title)}</h2>`;
    sel.forEach(secId => {
      const sec = r.sections[secId];
      if (!sec) return;
      html += `<center><h3>${escapeHtml(sec.title)}</h3></center>`;
      html += `<table><thead><tr><th>PAR√ÅMETRO</th><th><center>RESULTADO</center></th><th><center>UNIDAD</center></th><th>VALOR NORMAL/INTERPRETACION</th></tr></thead><tbody> `;
      sec.params.forEach(p => {
        const idSafe = `inp_${r.id}_${secId}_${slugify(p.k)}`;
        const el = document.getElementById(idSafe);
        if (!state.selectedParams[r.id][secId].has(p.k)) return;
        const val = el ? el.value : '';
        const escapedNormal = escapeHtml(p.normal || '');
        const htmlNormal = escapedNormal.replace(/\[\[br\]\]/g, '<br>');
        html += `<tr><td><strong>${escapeHtml(p.k)}</strong></td><td><center><strong>${escapeHtml(val)}</strong></center></td><td><strong><center>${escapeHtml(p.unit || '')}</center></strong></td><td><strong>${htmlNormal}</strong></td></tr>`;
      });
      html += `</tbody></table>`;
    });
    html += `</div>`;
  });

  html += `<div class="final-block">`;
  if (notes) html += `<div class="notes"><strong>Observaciones:</strong><div>${escapeHtml(notes)}</div></div>`;
  html += `<div class="sig"><div><strong>${escapeHtml(professional)}</strong><div>${escapeHtml(title)}</div></div><div><img src="${sig}" alt="firma"></div></div>`;
  html += `</div>`;

  html += `</div></body></html>`;
  return html;
}

function escapeHtml(str){
  if(!str) return '';
  return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

let _lastPreviewBlobURL = null;

async function openPreviewModal() {
  const haySecciones = Object.values(state.selectedSections).some(s => s.size > 0);
  if (!haySecciones) {
    alert('Marca al menos una secci√≥n de alg√∫n informe para generar la vista previa.');
    return;
  }

  try {
    await guardarInformeEnHistorial();
  } catch(e) {
    console.error('Error al exportar JSON autom√°tico:', e);
  }

  const html = buildCombinedHTML();
  if (_lastPreviewBlobURL) { 
    URL.revokeObjectURL(_lastPreviewBlobURL); 
    _lastPreviewBlobURL = null; 
  }
  
  const blob = new Blob([html], { type: 'text/html' });
  const blobURL = URL.createObjectURL(blob);
  _lastPreviewBlobURL = blobURL;
  previewFrame.src = blobURL;
  modalPreview.classList.add('open');
  modalPreview.setAttribute('aria-hidden', 'false');
  
  previewFrame.onload = () => {
    conectarEventoImprimir();
  };
}

function conectarEventoImprimir() {
  const btnImprimir = document.getElementById('modalPrint');
  if (btnImprimir) {
    btnImprimir.replaceWith(btnImprimir.cloneNode(true));
    const nuevoBtn = document.getElementById('modalPrint');
    nuevoBtn.addEventListener('click', imprimirVistaPrevia);
  }
  
}

async function imprimirVistaPrevia() {
  statusBox.textContent = 'Preparando impresi√≥n...';
  try {
    const html = buildCombinedHTML();
    const ventanaImpresion = window.open('', '_blank', 'width=800,height=600');
    if (!ventanaImpresion) {
      alert('Por favor permite ventanas emergentes para imprimir');
      return;
    }

    ventanaImpresion.document.write(html);
    ventanaImpresion.document.close();

    setTimeout(() => {
      try {
        ventanaImpresion.focus();
        ventanaImpresion.print();
        statusBox.textContent = 'Di√°logo de impresi√≥n abierto';
      } catch (error) {
        console.error('Error al imprimir:', error);
        statusBox.textContent = 'Error al imprimir';
      }
    }, 500);
  } catch (error) {
    console.error('Error al preparar impresi√≥n:', error);
    statusBox.textContent = 'Error al preparar impresi√≥n';
    alert('Error al intentar imprimir. Intenta guardar como PDF en su lugar.');
  }
}

modalClose.addEventListener('click', ()=>{
  previewFrame.src = 'about:blank';
  modalPreview.classList.remove('open');
  modalPreview.setAttribute('aria-hidden','true');
});

document.getElementById('btnNew').addEventListener('click', ()=>{
  if(!confirm('Limpiar todo y empezar nuevo informe?')) return;
  state.selectedReports = new Set(['hematologia']);
  Object.keys(state.selectedSections).forEach(k => state.selectedSections[k] = new Set());
  Object.keys(state.selectedParams).forEach(r => {
    Object.keys(state.selectedParams[r]).forEach(s => state.selectedParams[r][s] = new Set());
  });
  document.getElementById('p_historial').value = '';
  document.getElementById('p_nombre').value = '';
  document.getElementById('p_edad').value = '';
  document.getElementById('p_sexo').value = '';
  document.getElementById('p_reg').value = '';
  document.getElementById('p_fecha').valueAsDate = new Date();
  document.getElementById('finalNotes').value = '';
  document.getElementById('professionalSelect').value = '';
  document.getElementById('professionalTitle').value = '';
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  savedSigDataUrl = '';
  clearSavedReport();
  renderAll();
  statusBox.textContent = 'Nuevo informe listo';
});

selectAllSections.addEventListener('click', ()=>{
  Object.keys(REPORTS).forEach(rid=>{
    if(state.selectedReports.has(rid)){
      Object.keys(REPORTS[rid].sections).forEach(sid => state.selectedSections[rid].add(sid));
    }
  });
  renderAll();
});

deselectAllSections.addEventListener('click', ()=>{
  Object.keys(REPORTS).forEach(rid => state.selectedSections[rid] = new Set());
  renderAll();
});


let autoSaveTimer = null;

function scheduleAutoSave(){
  statusBox.textContent = 'Cambios detectados...';
  if(autoSaveTimer) clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(()=>{
    statusBox.textContent = 'Listo';
  }, 2000);
}

document.addEventListener('input', (e)=>{
  if(!document.body.contains(e.target)) return;
  scheduleAutoSave();
});

function renderAll(){
  renderReports();
  renderSectionSelectors();
  renderParameterForms();
}

document.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('p_fecha').valueAsDate = new Date();
  renderAll();

  const updateReportSelect = document.getElementById('updateReportSelect');
  const updateMode = document.getElementById('updateMode');
  const deleteReportSelect = document.getElementById('deleteReportSelect');
  const deleteMode = document.getElementById('deleteMode');

  if (updateReportSelect) {
    updateReportSelect.addEventListener('change', toggleUpdateFields);
  }
  
  if (updateMode) {
    updateMode.addEventListener('change', toggleUpdateFields);
  }
  
  if (deleteReportSelect) {
    deleteReportSelect.addEventListener('change', toggleDeleteFields);
  }
  
  if (deleteMode) {
    deleteMode.addEventListener('change', toggleDeleteFields);
  }
});

btnOpenPreview.addEventListener('click', openPreviewModal);
btnOpenPreview2.addEventListener('click', openPreviewModal);

/* ============ FUNCIONES DE MODALES ============ */

function openModal(modalId) {
  document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
  const modal = document.getElementById(modalId);
  modal.querySelectorAll('input[type="text"], textarea, select').forEach(el => el.value = '');
  modal.querySelectorAll('[id^="message"]').forEach(el => el.innerHTML = '');
}

document.querySelectorAll('.modal-overlay').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal(modal.id);
  });
});

// ============ MODAL: A√ëADIR INFORME ============

function addSectionField(containerId) {
  const container = document.getElementById(containerId);
  const sectionDiv = document.createElement('div');
  sectionDiv.className = 'section-container';
  sectionDiv.innerHTML = `
    <div class="section-input-group">
      <input type="text" placeholder="Nombre de secci√≥n (ej. Perfil Lip√≠dico)" class="section-title" required>
      <input type="text" placeholder="ID (ej. perfil_lipidico)" class="section-id" required style="flex: 0.8;">
      <button type="button" onclick="this.parentElement.parentElement.remove()" class="btn-remove-section">‚úï</button>
    </div>
    <div class="param-options">
      <div style="font-size: 12px; font-weight: 600; color: #0b3954; margin-bottom: 8px;">Par√°metros de esta secci√≥n:</div>
      <div class="params-list"></div>
      <button type="button" onclick="addParamField(this.closest('.param-options'))" class="btn-add-section" style="margin-top: 8px; font-size: 12px; padding: 8px 12px;">+ Par√°metro</button>
    </div>
  `;
  container.appendChild(sectionDiv);
}

function addParamField(container) {
  const paramsList = container.querySelector('.params-list');
  const paramDiv = document.createElement('div');
  paramDiv.className = 'param-option-item';
  paramDiv.innerHTML = `
    <input type="text" placeholder="Nombre par√°metro" class="param-name" required style="flex: 1;">
    <input type="text" placeholder="Unidad" class="param-unit" style="flex: 0.6;">
    <input type="text" placeholder="Normal" class="param-normal" style="flex: 0.6;">
    <button type="button" onclick="this.parentElement.remove()" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;">‚úï</button>
  `;
  paramsList.appendChild(paramDiv);
}

function ensureReportInState(reportId) {
  if (!state.selectedSections[reportId]) {
    state.selectedSections[reportId] = new Set();
    state.selectedParams[reportId] = {};
    Object.keys(REPORTS[reportId].sections).forEach(s => {
      state.selectedParams[reportId][s] = new Set();
    });
  }
}

function saveReportsConfigToLocal() {
  localStorage.setItem('reportsConfig', JSON.stringify(REPORTS));
}

function handleAddReport(event) {
  event.preventDefault();
  const title = document.getElementById('addReportTitle').value.trim();
  const id = document.getElementById('addReportId').value.trim().toLowerCase().replace(/[^a-z0-9]+/g, '');
  const icon = document.getElementById('addReportIcon').value.trim() || 'üß™';
  const messageDiv = document.getElementById('messageAddReport');

  if (!title || !id) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Completa todos los campos requeridos</div>';
    return;
  }

  if (REPORTS[id]) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Ya existe un informe con ese ID</div>';
    return;
  }

  const sections = {};
  let sectionCount = 0;

  document.querySelectorAll('#addReportSections .section-container').forEach(secContainer => {
    const secTitle = secContainer.querySelector('.section-title').value.trim();
    const secId = secContainer.querySelector('.section-id').value.trim().toLowerCase().replace(/[^a-z0-9]+/g, '');

    if (!secTitle || !secId) {
      messageDiv.innerHTML = '<div class="error-message">‚ùå Completa todos los IDs y t√≠tulos de secciones</div>';
      return;
    }

    const params = [];
    secContainer.querySelectorAll('.param-option-item').forEach(paramItem => {
      const name = paramItem.querySelector('.param-name').value.trim();
      const unit = paramItem.querySelector('.param-unit').value.trim() || '';
      const normal = paramItem.querySelector('.param-normal').value.trim() || '';

      if (name) {
        params.push({ k: name, unit, normal });
      }
    });

    if (params.length === 0) {
      messageDiv.innerHTML = '<div class="error-message">‚ùå Cada secci√≥n debe tener al menos un par√°metro</div>';
      return;
    }

    sections[secId] = { title: secTitle, params };
    sectionCount++;
  });

  if (sectionCount === 0) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Debes crear al menos una secci√≥n</div>';
    return;
  }

  REPORTS[id] = { id, icon, title, sections };
  ensureReportInState(id);
  state.selectedReports.add(id);
  saveReportsConfigToLocal();
  renderAll();

  messageDiv.innerHTML = '<div class="success-message">‚úÖ Informe creado exitosamente</div>';
  setTimeout(() => closeModal('modalAddReport'), 1500);
  statusBox.textContent = `Informe "${title}" a√±adido`;
}

// ============ MODAL: ACTUALIZAR INFORME ============

function loadUpdateReportOptions() {
  const select = document.getElementById('updateReportSelect');
  select.innerHTML = '<option value="">-- Selecciona un informe --</option>';
  Object.entries(REPORTS).forEach(([id, report]) => {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = `${report.icon} ${report.title}`;
    select.appendChild(option);
  });
}

function toggleUpdateFields() {
  const mode = document.getElementById('updateMode').value;
  const reportId = document.getElementById('updateReportSelect').value;
  const container = document.getElementById('updateFieldsContainer');

  if (!reportId) {
    container.innerHTML = '';
    return;
  }

  const report = REPORTS[reportId];
  container.innerHTML = '';

  if (mode === 'informe') {
    container.innerHTML = `
      <div class="form-group">
        <label>Nuevo T√≠tulo</label>
        <input type="text" id="updateTitle" value="${report.title}">
      </div>
      <div class="form-group">
        <label>Nuevo Icono</label>
        <input type="text" id="updateIcon" value="${report.icon}" maxlength="2">
      </div>
    `;
  } else if (mode === 'seccion') {
    const secSelect = document.createElement('select');
    secSelect.id = 'updateSectionSelect';
    secSelect.required = true;
    secSelect.innerHTML = '<option value="">-- Selecciona una secci√≥n --</option>';
    Object.entries(report.sections).forEach(([secId, section]) => {
      const opt = document.createElement('option');
      opt.value = secId;
      opt.textContent = section.title;
      secSelect.appendChild(opt);
    });

    container.innerHTML = '<div class="form-group"><label>Secci√≥n a actualizar *</label></div>';
    container.querySelector('.form-group').appendChild(secSelect);

    secSelect.addEventListener('change', () => {
      const secId = secSelect.value;
      if (secId) {
        const section = report.sections[secId];
        document.getElementById('updateFieldsContainer').innerHTML += `
          <div class="form-group">
            <label>Nuevo T√≠tulo de Secci√≥n</label>
            <input type="text" id="updateSectionTitle" value="${section.title}">
          </div>
        `;
      }
    });
  } else if (mode === 'parametro') {
    const secSelect = document.createElement('select');
    secSelect.id = 'deleteParamSectionSelect';
    secSelect.required = true;
    secSelect.innerHTML = '<option value="">-- Selecciona secci√≥n --</option>';
    Object.entries(report.sections).forEach(([secId, section]) => {
      const opt = document.createElement('option');
      opt.value = secId;
      opt.textContent = section.title;
      secSelect.appendChild(opt);
    });

    container.innerHTML = '<div class="form-group"><label>Secci√≥n *</label></div>';
    container.querySelector('.form-group').appendChild(secSelect);

    secSelect.addEventListener('change', () => {
      const secId = secSelect.value;
      if (secId) {
        const section = report.sections[secId];
        const paramSelect = document.createElement('select');
        paramSelect.id = 'updateParamSelect';
        paramSelect.required = true;
        paramSelect.innerHTML = '<option value="">-- Selecciona par√°metro --</option>';
        section.params.forEach((param, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = param.k;
          paramSelect.appendChild(opt);
        });

        document.getElementById('updateFieldsContainer').innerHTML += `
          <div class="form-group">
            <label>Par√°metro *</label>
          </div>
        `;
        document.querySelector('.form-group:last-child').appendChild(paramSelect);

        paramSelect.addEventListener('change', () => {
          const paramIdx = paramSelect.value;
          if (paramIdx !== '') {
            const param = section.params[paramIdx];
            document.getElementById('updateFieldsContainer').innerHTML += `
              <div class="form-group">
                <label>Nuevo Nombre</label>
                <input type="text" id="updateParamName" value="${param.k}">
              </div>
              <div class="form-group">
                <label>Nueva Unidad</label>
                <input type="text" id="updateParamUnit" value="${param.unit || ''}">
              </div>
              <div class="form-group">
                <label>Nuevo Valor Normal/Interpretacion</label>
                <input type="text" id="updateParamNormal" value="${param.normal || ''}">
              </div>
            `;
          }
        });
      }
    });
  }
}

function handleUpdateReport(event) {
  event.preventDefault();
  const reportId = document.getElementById('updateReportSelect').value;
  const mode = document.getElementById('updateMode').value;
  const report = REPORTS[reportId];
  const messageDiv = document.getElementById('messageUpdateReport');

  if (!reportId) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Selecciona un informe</div>';
    return;
  }

  try {
    if (mode === 'informe') {
      report.title = document.getElementById('updateTitle').value.trim();
      report.icon = document.getElementById('updateIcon').value.trim();
    } else if (mode === 'seccion') {
      const secId = document.getElementById('updateSectionSelect').value;
      const newTitle = document.getElementById('updateSectionTitle').value.trim();
      if (secId && newTitle) {
        report.sections[secId].title = newTitle;
      }
    } else if (mode === 'parametro') {
      const secId = document.getElementById('updateParamSectionSelect').value;
      const paramIdx = document.getElementById('updateParamSelect').value;
      if (secId && paramIdx !== '') {
        const param = report.sections[secId].params[paramIdx];
        param.k = document.getElementById('updateParamName').value.trim();
        param.unit = document.getElementById('updateParamUnit').value.trim();
        param.normal = document.getElementById('updateParamNormal').value.trim();
      }
    }

    saveReportsConfigToLocal();
    renderAll();
    messageDiv.innerHTML = '<div class="success-message">‚úÖ Actualizaci√≥n exitosa</div>';
    setTimeout(() => closeModal('modalUpdateReport'), 1500);
    statusBox.textContent = 'Configuraci√≥n actualizada';
  } catch (error) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Error al actualizar</div>';
  }
}

// ============ MODAL: ELIMINAR ============

function loadDeleteReportOptions() {
  const select = document.getElementById('deleteReportSelect');
  select.innerHTML = '<option value="">-- Selecciona un informe --</option>';
  Object.entries(REPORTS).forEach(([id, report]) => {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = `${report.icon} ${report.title}`;
    select.appendChild(option);
  });
}

function toggleDeleteFields() {
  const mode = document.getElementById('deleteMode').value;
  const reportId = document.getElementById('deleteReportSelect').value;
  const container = document.getElementById('deleteFieldsContainer');

  container.innerHTML = '';

  if (!reportId) return;

  const report = REPORTS[reportId];

  if (mode === 'seccion') {
    const secSelect = document.createElement('select');
    secSelect.id = 'deleteSectionSelect';
    secSelect.required = true;
    secSelect.innerHTML = '<option value="">-- Selecciona secci√≥n --</option>';
    Object.entries(report.sections).forEach(([secId, section]) => {
      const opt = document.createElement('option');
      opt.value = secId;
      opt.textContent = section.title;
      secSelect.appendChild(opt);
    });
    container.innerHTML = '<div class="form-group"><label>Secci√≥n a eliminar *</label></div>';
    container.querySelector('.form-group').appendChild(secSelect);
  } else if (mode === 'parametro') {
    const secSelect = document.createElement('select');
    secSelect.id = 'deleteParamSectionSelect';
    secSelect.required = true;
    secSelect.innerHTML = '<option value="">-- Selecciona secci√≥n --</option>';
    Object.entries(report.sections).forEach(([secId, section]) => {
      const opt = document.createElement('option');
      opt.value = secId;
      opt.textContent = section.title;
      secSelect.appendChild(opt);
    });

    container.innerHTML = '<div class="form-group"><label>Secci√≥n *</label></div>';
    container.querySelector('.form-group').appendChild(secSelect);

    secSelect.addEventListener('change', () => {
      const secId = secSelect.value;
      if (secId) {
        const section = report.sections[secId];
        const paramSelect = document.createElement('select');
        paramSelect.id = 'deleteParamSelect';
        paramSelect.required = true;
        paramSelect.innerHTML = '<option value="">-- Selecciona par√°metro --</option>';
        section.params.forEach((param, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          opt.textContent = param.k;
          paramSelect.appendChild(opt);
        });
        document.getElementById('deleteFieldsContainer').innerHTML += `
          <div class="form-group">
            <label>Par√°metro a eliminar *</label>
          </div>
        `;
        document.querySelector('.form-group:last-child').appendChild(paramSelect);
      }
    });
  }
}

function handleDeleteReport(event) {
  event.preventDefault();
  const reportId = document.getElementById('deleteReportSelect').value;
  const mode = document.getElementById('deleteMode').value;
  const messageDiv = document.getElementById('messageDeleteReport');

  if (!reportId) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Selecciona un informe</div>';
    return;
  }

  if (!confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO? Esta acci√≥n no se puede deshacer.')) {
    return;
  }

  try {
    if (mode === 'informe') {
      delete REPORTS[reportId];
      delete state.selectedSections[reportId];
      delete state.selectedParams[reportId];
      state.selectedReports.delete(reportId);
    } else if (mode === 'seccion') {
      const secId = document.getElementById('deleteSectionSelect').value;
      delete REPORTS[reportId].sections[secId];
      state.selectedSections[reportId].delete(secId);
    } else if (mode === 'parametro') {
      const secId = document.getElementById('deleteParamSectionSelect').value;
      const paramIdx = document.getElementById('deleteParamSelect').value;
      REPORTS[reportId].sections[secId].params.splice(paramIdx, 1);
    }

    saveReportsConfigToLocal();
    renderAll();
    messageDiv.innerHTML = '<div class="success-message">‚úÖ Eliminado exitosamente</div>';
    setTimeout(() => closeModal('modalDeleteReport'), 1500);
    statusBox.textContent = 'Elemento eliminado';
  } catch (error) {
    messageDiv.innerHTML = '<div class="error-message">‚ùå Error al eliminar</div>';
  }
}

// ============ EVENT LISTENERS: BOTONES (CORREGIDO) ============

const btnAddReport = document.getElementById('btnAddReport');
const btnUpdateReport = document.getElementById('btnUpdateReport');
const btnDeleteReport = document.getElementById('btnDeleteReport');

btnAddReport.addEventListener('click', () => {
  document.getElementById('addReportSections').innerHTML = '';
  document.getElementById('messageAddReport').innerHTML = '';
  openModal('modalAddReport');
});

btnUpdateReport.addEventListener('click', () => {
  loadUpdateReportOptions();
  document.getElementById('updateReportSelect').value = '';
  document.getElementById('updateMode').value = 'informe';
  document.getElementById('updateFieldsContainer').innerHTML = '';
  document.getElementById('messageUpdateReport').innerHTML = '';
  
  openModal('modalUpdateReport');
});

btnDeleteReport.addEventListener('click', () => {
  loadDeleteReportOptions();
  document.getElementById('deleteReportSelect').value = '';
  document.getElementById('deleteMode').value = 'informe';
  document.getElementById('deleteFieldsContainer').innerHTML = '';
  document.getElementById('messageDeleteReport').innerHTML = '';
  
  openModal('modalDeleteReport');
});

// ============ CONFIGURACIONES DEL LOGIN ============
function handleLogin(event) {
    event.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const error = document.getElementById('loginError');

    // Comparaci√≥n exacta (sensible a may√∫sculas/min√∫sculas)
    if (username === 'admin' && password === 'laboratorio') {
      document.getElementById('loginScreen').style.display = 'none';
      statusBox.textContent = 'Acceso concedido. Bienvenido.';
    } else {
      error.textContent = 'Usuario o contrase√±a incorrectos.';
    }
  }

  function togglePassword() {
    const input = document.getElementById('password');
    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';
  }
  // configuracion de cerrar sesion
  document.getElementById('btnLogout').addEventListener('click', () => {
    if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
      // Mostrar login de nuevo
      document.getElementById('loginScreen').style.display = 'flex';

      // Limpiar campos del login
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('loginError').textContent = '';

      // Opcional: limpiar datos del formulario si quieres
      // document.getElementById('p_nombre').value = '';
      // document.getElementById('p_edad').value = '';
      // etc...

      statusBox.textContent = 'Sesi√≥n cerrada.';
    }
  });

  //=========CLAVE DE SEGURIDAD PARA BLOQUEO DE LA PAGINA=======
  const CLAVE_SECRETA = "@stalossantospierdenlapaciencia"; // Cambia esto por tu clave
  const DURACION_DIAS = 60;
  const CLAVE_INICIO = "inicio_sistema";
  const CLAVE_BLOQUEO = "sistema_bloqueado";

  function diasDesde(fecha) {
    const hoy = new Date();
    const diferencia = hoy - new Date(fecha);
    return Math.floor(diferencia / (1000 * 60 * 60 * 24));
  }

  function bloquearSistema() {
    document.body.innerHTML = `
      <div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#f4f8fb;font-family:sans-serif;">
        <div style="background:white;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.1);text-align:center;">
          <h2 style="color:#dc3545;">Sistema bloqueado</h2>
          <p>El per√≠odo de Prueba ha expirado. Contacta al administrador +240 222 182-839.</p>
          <input id="claveDesbloqueo" type="password" placeholder="Ingresa la clave" style="padding:10px;width:100%;margin-top:10px;">
          <button onclick="intentarDesbloqueo()" style="margin-top:10px;padding:10px 20px;background:#0f9d8e;color:white;border:none;border-radius:6px;cursor:pointer;">Desbloquear</button>
          <p id="errorClave" style="color:red;margin-top:10px;"></p>
        </div>
      </div>
    `;
    localStorage.setItem(CLAVE_BLOQUEO, "true");
  }

  function intentarDesbloqueo() {
    const input = document.getElementById('claveDesbloqueo').value;
    const error = document.getElementById('errorClave');
    if (input === CLAVE_SECRETA) {
      localStorage.removeItem(CLAVE_BLOQUEO);
      localStorage.removeItem(CLAVE_INICIO);
      alert('Sistema desbloqueado. Recarga la p√°gina.');
      location.reload();
    } else {
      error.textContent = 'Clave incorrecta.';
    }
  }

  // Verificar estado al cargar
  window.addEventListener('DOMContentLoaded', () => {
    const bloqueado = localStorage.getItem(CLAVE_BLOQUEO) === "true";
    const inicio = localStorage.getItem(CLAVE_INICIO);

    if (bloqueado) {
      bloquearSistema();
      return;
    }

    if (!inicio) {
      // Primer acceso: registrar fecha
      localStorage.setItem(CLAVE_INICIO, new Date().toISOString());
    } else {
      const dias = diasDesde(inicio);
      if (dias >= DURACION_DIAS) {
        bloquearSistema();
      }
    }
  });
</script>
</body>
</html>

/* ¬© 2025 √Ångel Nicol√°s Esono WONG MODJO. Uso prohibido sin autorizaci√≥n escrita */
